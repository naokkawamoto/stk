<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>問い合わせ管理</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="../style.css">
    <style>
        .inquiry-card {
            border-left: 4px solid #dc3545;
            transition: all 0.3s ease;
        }
        .inquiry-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .inquiry-card.pending {
            border-left-color: #dc3545;
        }
        .inquiry-card.in-progress {
            border-left-color: #ffc107;
        }
        .inquiry-card.completed {
            border-left-color: #28a745;
        }
        .status-badge {
            font-size: 0.8rem;
        }
        .thread-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .message-bubble {
            max-width: 80%;
            margin-bottom: 15px;
        }
        .message-sent {
            margin-left: auto;
            background-color: #007bff;
            color: white;
        }
        .message-received {
            margin-right: auto;
            background-color: #f8f9fa;
            color: #333;
        }
        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <!-- ヘッダー -->
    <div id="header-container"></div>

    <div class="container-fluid mt-4 px-3">
        <!-- ページタイトル -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">問い合わせ管理</h4>
            <button class="btn btn-primary" onclick="refreshInquiries()">
                <i class="bi bi-arrow-clockwise"></i> 更新
            </button>
        </div>

        <!-- 統計情報 -->
        <div class="mb-3">
            <small class="text-muted">
                未対応: <span class="badge bg-danger">8件</span> | 
                対応中: <span class="badge bg-warning">12件</span>
            </small>
        </div>

        <!-- フィルター・検索 -->
        <div class="row mb-3">
            <div class="col-md-3">
                <select class="form-select" id="statusFilter">
                    <option value="">すべてのステータス</option>
                    <option value="pending">未対応</option>
                    <option value="in-progress">対応中</option>
                    <option value="completed">完了</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="email" class="form-control" placeholder="メールアドレスで検索..." id="emailSearch">
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" placeholder="件名で検索..." id="subjectSearch">
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline-primary w-100" onclick="applyFilters()">
                    <i class="bi bi-search"></i> 検索
                </button>
            </div>
        </div>

        <!-- 問い合わせ一覧 -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">問い合わせ一覧</h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <input type="radio" class="btn-check" name="sortOrder" id="sortNewest" autocomplete="off" checked>
                            <label class="btn btn-outline-primary" for="sortNewest">最新順</label>
                            <input type="radio" class="btn-check" name="sortOrder" id="sortOldest" autocomplete="off">
                            <label class="btn btn-outline-primary" for="sortOldest">古い順</label>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush" id="inquiryList">
                            <!-- 問い合わせ1 -->
                            <div class="list-group-item inquiry-card pending" data-id="1" data-status="pending" data-email="user1@example.com" data-date="2025-01-15T10:30:00">
                                <div class="d-flex w-100 justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-1">システムの不具合について</h6>
                                            <span class="badge bg-danger status-badge">未対応</span>
                                        </div>
                                        <p class="mb-2 text-muted">ログイン時にエラーが発生します。解決方法を教えてください。</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                <i class="bi bi-building"></i> ZERO×STYLE
                                                <i class="bi bi-person"></i> 山田太郎
                                                <i class="bi bi-envelope"></i> user1@example.com
                                                <i class="bi bi-calendar"></i> 2025-01-15 10:30
                                            </small>
                                            <button class="btn btn-outline-primary btn-sm" onclick="viewInquiryDetail(1)">
                                                <i class="bi bi-chat-dots"></i> 詳細
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 問い合わせ2 -->
                            <div class="list-group-item inquiry-card in-progress" data-id="2" data-status="in-progress" data-email="user2@example.com" data-date="2025-01-14T15:20:00">
                                <div class="d-flex w-100 justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-1">料金プランの変更について</h6>
                                            <span class="badge bg-warning status-badge">対応中</span>
                                        </div>
                                        <p class="mb-2 text-muted">現在のプランから上位プランに変更したいのですが、手続き方法を教えてください。</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                <i class="bi bi-building"></i> ABC建設
                                                <i class="bi bi-person"></i> 佐藤花子
                                                <i class="bi bi-envelope"></i> user2@example.com
                                                <i class="bi bi-calendar"></i> 2025-01-14 15:20
                                            </small>
                                            <button class="btn btn-outline-primary btn-sm" onclick="viewInquiryDetail(2)">
                                                <i class="bi bi-chat-dots"></i> 詳細
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 問い合わせ3 -->
                            <div class="list-group-item inquiry-card completed" data-id="3" data-status="completed" data-email="user3@example.com" data-date="2025-01-13T09:15:00">
                                <div class="d-flex w-100 justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-1">アカウントの削除について</h6>
                                            <span class="badge bg-success status-badge">完了</span>
                                        </div>
                                        <p class="mb-2 text-muted">アカウントを削除したいのですが、データのバックアップは可能ですか？</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                <i class="bi bi-building"></i> 田中設計
                                                <i class="bi bi-person"></i> 高橋次郎
                                                <i class="bi bi-envelope"></i> user3@example.com
                                                <i class="bi bi-calendar"></i> 2025-01-13 09:15
                                            </small>
                                            <button class="btn btn-outline-primary btn-sm" onclick="viewInquiryDetail(3)">
                                                <i class="bi bi-chat-dots"></i> 詳細
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 問い合わせ4 -->
                            <div class="list-group-item inquiry-card pending" data-id="4" data-status="pending" data-email="user4@example.com" data-date="2025-01-12T14:45:00">
                                <div class="d-flex w-100 justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-1">新機能のリクエスト</h6>
                                            <span class="badge bg-danger status-badge">未対応</span>
                                        </div>
                                        <p class="mb-2 text-muted">データのエクスポート機能を追加していただけませんか？</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                <i class="bi bi-building"></i> 鈴木工務店
                                                <i class="bi bi-person"></i> 伊藤三郎
                                                <i class="bi bi-envelope"></i> user4@example.com
                                                <i class="bi bi-calendar"></i> 2025-01-12 14:45
                                            </small>
                                            <button class="btn btn-outline-primary btn-sm" onclick="viewInquiryDetail(4)">
                                                <i class="bi bi-chat-dots"></i> 詳細
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 問い合わせ5 -->
                            <div class="list-group-item inquiry-card in-progress" data-id="5" data-status="in-progress" data-email="user5@example.com" data-date="2025-01-11T11:30:00">
                                <div class="d-flex w-100 justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-1">パスワードのリセット</h6>
                                            <span class="badge bg-warning status-badge">対応中</span>
                                        </div>
                                        <p class="mb-2 text-muted">パスワードを忘れてしまいました。リセット方法を教えてください。</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                <i class="bi bi-building"></i> 渡辺建築
                                                <i class="bi bi-person"></i> 中村四郎
                                                <i class="bi bi-envelope"></i> user5@example.com
                                                <i class="bi bi-calendar"></i> 2025-01-11 11:30
                                            </small>
                                            <button class="btn btn-outline-primary btn-sm" onclick="viewInquiryDetail(5)">
                                                <i class="bi bi-chat-dots"></i> 詳細
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ページネーション -->
                <nav aria-label="Page navigation" class="mt-4">
                    <ul class="pagination justify-content-center">
                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>

            <!-- 詳細パネル -->
            <div class="col-md-4">
                <div class="card" id="detailPanel" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">問い合わせ詳細</h5>
                        <button type="button" class="btn-close" onclick="closeDetailPanel()"></button>
                    </div>
                    <div class="card-body">
                        <!-- 問い合わせ情報 -->
                        <div class="mb-3">
                            <h6 id="detailSubject">件名</h6>
                            <p class="text-muted mb-2" id="detailContent">内容</p>
                            <div class="row mb-2">
                                <div class="col-6">
                                    <small class="text-muted">
                                        <i class="bi bi-building"></i> <span id="detailClient">クライアント名</span>
                                    </small>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">
                                        <i class="bi bi-person"></i> <span id="detailAssignee">担当者名</span>
                                    </small>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6">
                                    <small class="text-muted">
                                        <i class="bi bi-envelope"></i> <span id="detailEmail">メールアドレス</span>
                                    </small>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">
                                        <i class="bi bi-calendar"></i> <span id="detailDate">日時</span>
                                    </small>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="badge" id="detailStatus">ステータス</span>
                                <select class="form-select form-select-sm" id="statusChange" style="width: auto;">
                                    <option value="pending">未対応</option>
                                    <option value="in-progress">対応中</option>
                                    <option value="completed">完了</option>
                                </select>
                            </div>
                        </div>

                        <!-- スレッド表示 -->
                        <div class="thread-container border rounded p-3 mb-3" style="height: 400px;">
                            <div id="threadMessages">
                                <!-- メッセージがここに表示されます -->
                            </div>
                        </div>

                        <!-- 返信フォーム -->
                        <div class="mb-3">
                            <label for="replyMessage" class="form-label">返信メッセージ</label>
                            <textarea class="form-control" id="replyMessage" rows="3" placeholder="返信内容を入力してください..."></textarea>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button class="btn btn-outline-secondary btn-sm" onclick="closeDetailPanel()">閉じる</button>
                            <button class="btn btn-primary btn-sm" onclick="sendReply()">返信送信</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- フッター -->
    <div id="footer-container"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../style.js"></script>
    <script>
        // ヘッダー＆フッター読み込み
        fetch('provider_header.html').then(r=>r.text()).then(html=>document.getElementById('header-container').innerHTML=html);
        fetch('provider_footer.html').then(r=>r.text()).then(html=>document.getElementById('footer-container').innerHTML=html);

        // サンプルデータ
        const inquiryData = {
            1: {
                subject: "システムの不具合について",
                content: "ログイン時にエラーが発生します。解決方法を教えてください。",
                email: "user1@example.com",
                client: "ZERO×STYLE",
                assignee: "山田太郎",
                date: "2025-01-15 10:30",
                status: "pending",
                messages: [
                    {
                        type: "received",
                        content: "ログイン時にエラーが発生します。解決方法を教えてください。",
                        time: "2025-01-15 10:30",
                        sender: "user1@example.com"
                    }
                ]
            },
            2: {
                subject: "料金プランの変更について",
                content: "現在のプランから上位プランに変更したいのですが、手続き方法を教えてください。",
                email: "user2@example.com",
                client: "ABC建設",
                assignee: "佐藤花子",
                date: "2025-01-14 15:20",
                status: "in-progress",
                messages: [
                    {
                        type: "received",
                        content: "現在のプランから上位プランに変更したいのですが、手続き方法を教えてください。",
                        time: "2025-01-14 15:20",
                        sender: "user2@example.com"
                    },
                    {
                        type: "sent",
                        content: "プラン変更についてご連絡いたします。管理画面の「設定」→「プラン変更」から手続きいただけます。",
                        time: "2025-01-14 16:45",
                        sender: "サポート担当"
                    },
                    {
                        type: "received",
                        content: "ありがとうございます。手続きを進めてみます。",
                        time: "2025-01-14 17:30",
                        sender: "user2@example.com"
                    }
                ]
            },
            3: {
                subject: "アカウントの削除について",
                content: "アカウントを削除したいのですが、データのバックアップは可能ですか？",
                email: "user3@example.com",
                client: "田中設計",
                assignee: "高橋次郎",
                date: "2025-01-13 09:15",
                status: "completed",
                messages: [
                    {
                        type: "received",
                        content: "アカウントを削除したいのですが、データのバックアップは可能ですか？",
                        time: "2025-01-13 09:15",
                        sender: "user3@example.com"
                    },
                    {
                        type: "sent",
                        content: "データのバックアップは可能です。削除前にエクスポート機能をご利用ください。",
                        time: "2025-01-13 10:30",
                        sender: "サポート担当"
                    },
                    {
                        type: "received",
                        content: "承知いたしました。バックアップを取ってから削除手続きを進めます。",
                        time: "2025-01-13 11:15",
                        sender: "user3@example.com"
                    },
                    {
                        type: "sent",
                        content: "お疲れ様でした。何かご不明な点がございましたら、お気軽にお問い合わせください。",
                        time: "2025-01-13 11:30",
                        sender: "サポート担当"
                    }
                ]
            },
            4: {
                subject: "新機能のリクエスト",
                content: "データのエクスポート機能を追加していただけませんか？",
                email: "user4@example.com",
                client: "鈴木工務店",
                assignee: "伊藤三郎",
                date: "2025-01-12 14:45",
                status: "pending",
                messages: [
                    {
                        type: "received",
                        content: "データのエクスポート機能を追加していただけませんか？",
                        time: "2025-01-12 14:45",
                        sender: "user4@example.com"
                    }
                ]
            },
            5: {
                subject: "パスワードのリセット",
                content: "パスワードを忘れてしまいました。リセット方法を教えてください。",
                email: "user5@example.com",
                client: "渡辺建築",
                assignee: "中村四郎",
                date: "2025-01-11 11:30",
                status: "in-progress",
                messages: [
                    {
                        type: "received",
                        content: "パスワードを忘れてしまいました。リセット方法を教えてください。",
                        time: "2025-01-11 11:30",
                        sender: "user5@example.com"
                    },
                    {
                        type: "sent",
                        content: "パスワードリセットのリンクを送信いたします。メールをご確認ください。",
                        time: "2025-01-11 12:00",
                        sender: "サポート担当"
                    }
                ]
            }
        };

        // 問い合わせ詳細を表示
        function viewInquiryDetail(id) {
            const inquiry = inquiryData[id];
            if (!inquiry) return;

            // 詳細パネルを表示
            document.getElementById('detailPanel').style.display = 'block';

            // 問い合わせ情報を設定
            document.getElementById('detailSubject').textContent = inquiry.subject;
            document.getElementById('detailContent').textContent = inquiry.content;
            document.getElementById('detailClient').textContent = inquiry.client;
            document.getElementById('detailAssignee').textContent = inquiry.assignee;
            document.getElementById('detailEmail').textContent = inquiry.email;
            document.getElementById('detailDate').textContent = inquiry.date;
            
            // ステータスバッジを設定
            const statusBadge = document.getElementById('detailStatus');
            statusBadge.textContent = getStatusText(inquiry.status);
            statusBadge.className = `badge ${getStatusClass(inquiry.status)}`;
            
            // ステータス選択を設定
            document.getElementById('statusChange').value = inquiry.status;

            // スレッドメッセージを表示
            displayThreadMessages(inquiry.messages);
        }

        // スレッドメッセージを表示
        function displayThreadMessages(messages) {
            const container = document.getElementById('threadMessages');
            container.innerHTML = '';

            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message-bubble ${message.type === 'sent' ? 'message-sent' : 'message-received'}`;
                
                messageDiv.innerHTML = `
                    <div class="p-3 rounded">
                        <div class="mb-2">${message.content}</div>
                        <div class="message-time d-flex justify-content-between">
                            <span>${message.sender}</span>
                            <span>${message.time}</span>
                        </div>
                    </div>
                `;
                
                container.appendChild(messageDiv);
            });

            // 最新メッセージにスクロール
            container.scrollTop = container.scrollHeight;
        }

        // ステータステキストを取得
        function getStatusText(status) {
            const statusMap = {
                'pending': '未対応',
                'in-progress': '対応中',
                'completed': '完了'
            };
            return statusMap[status] || status;
        }

        // ステータスクラスを取得
        function getStatusClass(status) {
            const classMap = {
                'pending': 'bg-danger',
                'in-progress': 'bg-warning',
                'completed': 'bg-success'
            };
            return classMap[status] || 'bg-secondary';
        }

        // 詳細パネルを閉じる
        function closeDetailPanel() {
            document.getElementById('detailPanel').style.display = 'none';
        }

        // 返信を送信
        function sendReply() {
            const message = document.getElementById('replyMessage').value.trim();
            if (!message) {
                alert('返信内容を入力してください');
                return;
            }

            // 実際の実装ではサーバーに送信
            alert('返信を送信しました');
            
            // フォームをクリア
            document.getElementById('replyMessage').value = '';
        }

        // フィルターを適用
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const emailSearch = document.getElementById('emailSearch').value.toLowerCase();
            const subjectSearch = document.getElementById('subjectSearch').value.toLowerCase();
            
            const inquiries = document.querySelectorAll('.list-group-item');
            
            inquiries.forEach(inquiry => {
                const status = inquiry.getAttribute('data-status');
                const email = inquiry.getAttribute('data-email').toLowerCase();
                const subject = inquiry.querySelector('h6').textContent.toLowerCase();
                
                let show = true;
                
                // ステータスフィルター
                if (statusFilter && status !== statusFilter) {
                    show = false;
                }
                
                // メール検索
                if (emailSearch && !email.includes(emailSearch)) {
                    show = false;
                }
                
                // 件名検索
                if (subjectSearch && !subject.includes(subjectSearch)) {
                    show = false;
                }
                
                inquiry.style.display = show ? 'block' : 'none';
            });
        }

        // 問い合わせを更新
        function refreshInquiries() {
            // 実際の実装ではサーバーから最新データを取得
            alert('問い合わせ一覧を更新しました');
        }

        // 統計情報を更新
        function updateStats() {
            const totalInquiries = document.querySelectorAll('.list-group-item').length;
            const pendingCount = document.querySelectorAll('[data-status="pending"]').length;
            const inProgressCount = document.querySelectorAll('[data-status="in-progress"]').length;
            const completedCount = document.querySelectorAll('[data-status="completed"]').length;
            
            document.getElementById('totalInquiries').textContent = totalInquiries;
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('inProgressCount').textContent = inProgressCount;
            document.getElementById('completedCount').textContent = completedCount;
        }

        // ページ読み込み時に統計を更新
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
        });
    </script>
</body>
</html>
