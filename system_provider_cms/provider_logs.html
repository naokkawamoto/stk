<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>監査ログ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="../style.css">
    <style>
        .log-table {
            font-size: 0.9rem;
        }
        .log-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        .log-table td {
            vertical-align: middle;
        }
        .action-badge {
            font-size: 0.75rem;
        }
        .filter-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- ヘッダー -->
    <div id="header-container"></div>

    <div class="container-fluid mt-4 px-3">
        <!-- ページタイトル -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">監査ログ</h4>
            <div>
                <button class="btn btn-outline-primary me-2" onclick="refreshLogs()">
                    <i class="bi bi-arrow-clockwise"></i> 更新
                </button>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#exportModal">
                    <i class="bi bi-download"></i> エクスポート
                </button>
            </div>
        </div>


        <!-- フィルター・検索 -->
        <div class="filter-section">
            <h6 class="mb-3"><i class="bi bi-funnel"></i> フィルター・検索</h6>
            <div class="row">
                <div class="col-md-2">
                    <label class="form-label small">ClientID</label>
                    <select class="form-select form-select-sm" id="clientFilter">
                        <option value="">すべて</option>
                        <option value="CLI001">CLI001 - ZERO×STYLE</option>
                        <option value="CLI002">CLI002 - ABC建設</option>
                        <option value="CLI003">CLI003 - 田中設計</option>
                        <option value="CLI004">CLI004 - 鈴木工務店</option>
                        <option value="CLI005">CLI005 - 渡辺建築</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">User ID</label>
                    <input type="text" class="form-control form-control-sm" placeholder="User ID" id="userFilter">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Action</label>
                    <select class="form-select form-select-sm" id="actionFilter">
                        <option value="">すべて</option>
                        <option value="LOGIN">ログイン</option>
                        <option value="LOGOUT">ログアウト</option>
                        <option value="CREATE">作成</option>
                        <option value="UPDATE">更新</option>
                        <option value="DELETE">削除</option>
                        <option value="VIEW">閲覧</option>
                        <option value="DOWNLOAD">ダウンロード</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Page ID</label>
                    <input type="text" class="form-control form-control-sm" placeholder="Page ID" id="pageFilter">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">日付範囲</label>
                    <input type="date" class="form-control form-control-sm" id="dateFrom">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">～</label>
                    <input type="date" class="form-control form-control-sm" id="dateTo">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12">
                    <button class="btn btn-primary btn-sm me-2" onclick="applyFilters()">
                        <i class="bi bi-search"></i> 検索
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                        <i class="bi bi-x-circle"></i> クリア
                    </button>
                </div>
            </div>
        </div>


        <!-- ログテーブル -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">監査ログ一覧</h5>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="sortOrder" id="sortNewest" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="sortNewest">最新順</label>
                    <input type="radio" class="btn-check" name="sortOrder" id="sortOldest" autocomplete="off">
                    <label class="btn btn-outline-primary" for="sortOldest">古い順</label>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover log-table mb-0" id="logTable">
                        <thead>
                            <tr>
                                <th style="width: 8%;">Log ID</th>
                                <th style="width: 12%;">ClientID</th>
                                <th style="width: 10%;">User ID</th>
                                <th style="width: 15%;">Date</th>
                                <th style="width: 12%;">Action</th>
                                <th style="width: 15%;">Page ID</th>
                                <th style="width: 15%;">IP Address</th>
                                <th style="width: 13%;">User Agent</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>LOG001247</code></td>
                                <td>
                                    <span class="badge bg-primary">CLI001</span><br>
                                    <small class="text-muted">ZERO×STYLE</small>
                                </td>
                                <td><code>USR001</code></td>
                                <td>2025-01-15 14:32:15</td>
                                <td><span class="badge bg-success action-badge">LOGIN</span></td>
                                <td><code>/login</code></td>
                                <td><small>192.168.1.100</small></td>
                                <td><small>Mozilla/5.0...</small></td>
                            </tr>
                            <tr>
                                <td><code>LOG001246</code></td>
                                <td>
                                    <span class="badge bg-primary">CLI002</span><br>
                                    <small class="text-muted">ABC建設</small>
                                </td>
                                <td><code>USR002</code></td>
                                <td>2025-01-15 14:28:42</td>
                                <td><span class="badge bg-info action-badge">CREATE</span></td>
                                <td><code>/projects/create</code></td>
                                <td><small>192.168.1.101</small></td>
                                <td><small>Chrome/120.0...</small></td>
                            </tr>
                            <tr>
                                <td><code>LOG001245</code></td>
                                <td>
                                    <span class="badge bg-primary">CLI001</span><br>
                                    <small class="text-muted">ZERO×STYLE</small>
                                </td>
                                <td><code>USR001</code></td>
                                <td>2025-01-15 14:25:18</td>
                                <td><span class="badge bg-warning action-badge">UPDATE</span></td>
                                <td><code>/projects/edit/123</code></td>
                                <td><small>192.168.1.100</small></td>
                                <td><small>Mozilla/5.0...</small></td>
                            </tr>
                            <tr>
                                <td><code>LOG001244</code></td>
                                <td>
                                    <span class="badge bg-primary">CLI003</span><br>
                                    <small class="text-muted">田中設計</small>
                                </td>
                                <td><code>USR003</code></td>
                                <td>2025-01-15 14:22:55</td>
                                <td><span class="badge bg-secondary action-badge">VIEW</span></td>
                                <td><code>/dashboard</code></td>
                                <td><small>192.168.1.102</small></td>
                                <td><small>Safari/17.0...</small></td>
                            </tr>
                            <tr>
                                <td><code>LOG001243</code></td>
                                <td>
                                    <span class="badge bg-primary">CLI004</span><br>
                                    <small class="text-muted">鈴木工務店</small>
                                </td>
                                <td><code>USR004</code></td>
                                <td>2025-01-15 14:20:33</td>
                                <td><span class="badge bg-danger action-badge">DELETE</span></td>
                                <td><code>/projects/delete/456</code></td>
                                <td><small>192.168.1.103</small></td>
                                <td><small>Edge/120.0...</small></td>
                            </tr>
                            <tr>
                                <td><code>LOG001242</code></td>
                                <td>
                                    <span class="badge bg-primary">CLI005</span><br>
                                    <small class="text-muted">渡辺建築</small>
                                </td>
                                <td><code>USR005</code></td>
                                <td>2025-01-15 14:18:07</td>
                                <td><span class="badge bg-success action-badge">DOWNLOAD</span></td>
                                <td><code>/reports/export</code></td>
                                <td><small>192.168.1.104</small></td>
                                <td><small>Firefox/121.0...</small></td>
                            </tr>
                            <tr>
                                <td><code>LOG001241</code></td>
                                <td>
                                    <span class="badge bg-primary">CLI002</span><br>
                                    <small class="text-muted">ABC建設</small>
                                </td>
                                <td><code>USR002</code></td>
                                <td>2025-01-15 14:15:44</td>
                                <td><span class="badge bg-dark action-badge">LOGOUT</span></td>
                                <td><code>/logout</code></td>
                                <td><small>192.168.1.101</small></td>
                                <td><small>Chrome/120.0...</small></td>
                            </tr>
                            <tr>
                                <td><code>LOG001240</code></td>
                                <td>
                                    <span class="badge bg-primary">CLI001</span><br>
                                    <small class="text-muted">ZERO×STYLE</small>
                                </td>
                                <td><code>USR001</code></td>
                                <td>2025-01-15 14:12:21</td>
                                <td><span class="badge bg-info action-badge">CREATE</span></td>
                                <td><code>/users/create</code></td>
                                <td><small>192.168.1.100</small></td>
                                <td><small>Mozilla/5.0...</small></td>
                            </tr>
                            <tr>
                                <td><code>LOG001239</code></td>
                                <td>
                                    <span class="badge bg-primary">CLI003</span><br>
                                    <small class="text-muted">田中設計</small>
                                </td>
                                <td><code>USR003</code></td>
                                <td>2025-01-15 14:09:58</td>
                                <td><span class="badge bg-warning action-badge">UPDATE</span></td>
                                <td><code>/settings/profile</code></td>
                                <td><small>192.168.1.102</small></td>
                                <td><small>Safari/17.0...</small></td>
                            </tr>
                            <tr>
                                <td><code>LOG001238</code></td>
                                <td>
                                    <span class="badge bg-primary">CLI004</span><br>
                                    <small class="text-muted">鈴木工務店</small>
                                </td>
                                <td><code>USR004</code></td>
                                <td>2025-01-15 14:06:35</td>
                                <td><span class="badge bg-secondary action-badge">VIEW</span></td>
                                <td><code>/projects/list</code></td>
                                <td><small>192.168.1.103</small></td>
                                <td><small>Edge/120.0...</small></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ページネーション -->
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item">
                    <a class="page-link" href="#" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item"><a class="page-link" href="#">4</a></li>
                <li class="page-item"><a class="page-link" href="#">5</a></li>
                <li class="page-item">
                    <a class="page-link" href="#" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- エクスポートモーダル -->
    <div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exportModalLabel">ログエクスポート</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
                </div>
                <div class="modal-body">
                    <form id="exportForm">
                        <div class="mb-3">
                            <label class="form-label">形式</label>
                            <div class="form-control-plaintext">CSV</div>
                        </div>
                        <div class="mb-3">
                            <label for="exportPeriod" class="form-label">期間</label>
                            <select class="form-select" id="exportPeriod" required onchange="toggleCustomDateRange()">
                                <option value="today">本日</option>
                                <option value="week">今週</option>
                                <option value="month">今月</option>
                                <option value="custom">カスタム</option>
                            </select>
                        </div>
                        <div class="mb-3" id="customDateRange" style="display: none;">
                            <label for="startDate" class="form-label">開始日</label>
                            <input type="date" class="form-control" id="startDate">
                            <label for="endDate" class="form-label mt-2">終了日</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-success" onclick="executeExport()">
                        <i class="bi bi-download"></i> エクスポート実行
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- フッター -->
    <div id="footer-container"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../style.js"></script>
    <script>
        // ヘッダー＆フッター読み込み
        fetch('provider_header.html').then(r=>r.text()).then(html=>document.getElementById('header-container').innerHTML=html);
        fetch('provider_footer.html').then(r=>r.text()).then(html=>document.getElementById('footer-container').innerHTML=html);

        // フィルターを適用
        function applyFilters() {
            const clientFilter = document.getElementById('clientFilter').value;
            const userFilter = document.getElementById('userFilter').value.toLowerCase();
            const actionFilter = document.getElementById('actionFilter').value;
            const pageFilter = document.getElementById('pageFilter').value.toLowerCase();
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            const rows = document.querySelectorAll('#logTable tbody tr');
            
            rows.forEach(row => {
                const clientId = row.querySelector('td:nth-child(2) .badge').textContent;
                const userId = row.querySelector('td:nth-child(3) code').textContent.toLowerCase();
                const action = row.querySelector('td:nth-child(5) .badge').textContent;
                const pageId = row.querySelector('td:nth-child(6) code').textContent.toLowerCase();
                const date = row.querySelector('td:nth-child(4)').textContent.split(' ')[0];
                
                let show = true;
                
                // ClientIDフィルター
                if (clientFilter && clientId !== clientFilter) {
                    show = false;
                }
                
                // User IDフィルター
                if (userFilter && !userId.includes(userFilter)) {
                    show = false;
                }
                
                // Actionフィルター
                if (actionFilter && action !== actionFilter) {
                    show = false;
                }
                
                // Page IDフィルター
                if (pageFilter && !pageId.includes(pageFilter)) {
                    show = false;
                }
                
                // 日付フィルター
                if (dateFrom && date < dateFrom) {
                    show = false;
                }
                if (dateTo && date > dateTo) {
                    show = false;
                }
                
                row.style.display = show ? '' : 'none';
            });
            
        }

        // フィルターをクリア
        function clearFilters() {
            document.getElementById('clientFilter').value = '';
            document.getElementById('userFilter').value = '';
            document.getElementById('actionFilter').value = '';
            document.getElementById('pageFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            
            // すべての行を表示
            const rows = document.querySelectorAll('#logTable tbody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
            
        }

        // ログを更新
        function refreshLogs() {
            // 実際の実装ではサーバーから最新データを取得
            alert('監査ログを更新しました');
        }

        // ログをエクスポート
        function exportLogs() {
            const format = document.getElementById('exportFormat').value;
            const period = document.getElementById('exportPeriod').value;
            const limit = document.getElementById('exportLimit').value;
            
            alert(`${format.toUpperCase()}形式で${period}のログを${limit === 'all' ? 'すべて' : limit + '件'}エクスポートします`);
        }

        // エクスポート実行
        function executeExport() {
            const period = document.getElementById('exportPeriod').value;
            
            // カスタム期間の場合は日付を取得
            let periodText = period;
            if (period === 'custom') {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                if (!startDate || !endDate) {
                    alert('カスタム期間を選択した場合は、開始日と終了日を入力してください');
                    return;
                }
                periodText = `${startDate} ～ ${endDate}`;
            }
            
            alert(`CSV形式で${periodText}のログをエクスポートを開始します`);
            
            // モーダルを閉じる
            const modal = bootstrap.Modal.getInstance(document.getElementById('exportModal'));
            modal.hide();
        }

        // 期間選択の変更処理
        function toggleCustomDateRange() {
            const period = document.getElementById('exportPeriod').value;
            const customDateRange = document.getElementById('customDateRange');
            
            if (period === 'custom') {
                customDateRange.style.display = 'block';
            } else {
                customDateRange.style.display = 'none';
            }
        }


        // ページ読み込み時の初期設定
        document.addEventListener('DOMContentLoaded', function() {
            // 今日の日付をデフォルトに設定
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFrom').value = today;
            document.getElementById('dateTo').value = today;
        });
    </script>
</body>
</html>