<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>案件管理（プラン）</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css" rel="stylesheet"/>
    <style>
        /* 全体左右マージン */
        .content-wrapper {
        margin: 0 auto;
        padding: 0 1rem;
        }
        /* カードを小さく */
        .card-project {
        font-size: 0.75rem;
        }
        .card-project .card-header {
        padding: 0.4rem 0.6rem;
        }
        .card-project .card-body {
        padding: 0.5rem;
        }
        .card-project .btn {
        font-size: 0.8rem;
        padding: 0.4rem 0.6rem;
        }
    </style>
</head>
<body>
    <!-- ヘッダー -->
    <div id="header-container"></div>

    <div class="content-wrapper mt-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <h5 class="mb-0">会社名</h5>
                <h4 class="mb-0 d-inline">案件名 <i class="bi bi-star"></i></h4>
            </div>
            <button class="btn btn-primary" type="button" onclick="location.href='userproject_detail_design.html'">
                <i class="bi bi-arrow-return-left"></i> プラン一覧へ戻る
            </button>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0">プラン１ <i class="bi bi-pencil-square"></i></h3>
            <!-- nav-pills に変更 -->
            <ul class="nav nav-pills">
                <li class="nav-item">
                    <a class="nav-link" href="user_project_detail_design.html"><i class="bi bi-sticky"></i>概要</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="user_project_detail_design_estimate.html"><i class="bi bi-calculator"></i> 業者見積もり</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="user_project_detail_design_owner_estimate.html"><i class="bi bi-calculator"></i> お客様見積もり</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="user_project_detail_design_finance.html"><i class="bi bi-currency-yen"></i> 資金計画</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="user_project_detail_design_doc.html"><i class="bi bi-folder"></i> 資料</a>
                </li>
            </ul>
        </div>

        <div class="p-3">
            <!-- ヘッダー情報 -->
            <h4 class="mb-3"><a href="user_project_detail_design_estimate.html">業者見積もり</a> ＞<a href="user_project_detail_estimate_detail.html">仮設工事</a> ＞自社対応見積もり</h3>

            <!-- サブタブ -->
            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-create">見積もり作成</button>
                </li>
            </ul>

            <div class="tab-content">
                <!-- 見積もり作成 -->
                <div class="tab-pane fade show active" id="tab-create">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">自社対応見積もり</h5>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" id="editBtn" onclick="toggleEditMode()">
                                <i class="bi bi-pencil"></i> 編集
                            </button>
                            <button class="btn btn-success btn-sm" id="addRowBtn" onclick="addNewRow()" style="display: none;">
                                <i class="bi bi-plus-circle"></i> 行追加
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive small-text">
                        <table class="table table-hover table-bordered small-text align-middle">
                            <thead class="table-dark text-white text-center">
                                <tr>
                                    <th>摘要</th>
                                    <th>社内適用</th>
                                    <th>数量定義</th>
                                    <th>数量</th>
                                    <th>単位</th>
                                    <th>実行単価（税抜き）</th>
                                    <th>実行金額（税抜き）</th>
                                    <th>備考</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>足場架払</td>
                                    <td>メッシュシート含む</td>
                                    <td>(外周＋8M)＊高さ</td>
                                    <td class="text-end">1.00</td>
                                    <td>㎡</td>
                                    <td class="text-end">800</td>
                                    <td class="text-end">800</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>同　昇降階段</td>
                                    <td></td>
                                    <td>必須項目</td>
                                    <td class="text-end">1.00</td>
                                    <td>式</td>
                                    <td class="text-end">22,000</td>
                                    <td class="text-end">22,000</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>内部足場架払</td>
                                    <td>吹抜け</td>
                                    <td>有りの場合</td>
                                    <td class="text-end">1.00</td>
                                    <td>式</td>
                                    <td class="text-end">28,000</td>
                                    <td class="text-end">28,000</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>内部養生材費用</td>
                                    <td></td>
                                    <td>延床面積</td>
                                    <td class="text-end">100.00</td>
                                    <td>㎡</td>
                                    <td class="text-end">320</td>
                                    <td class="text-end">32,000</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>清掃・美装</td>
                                    <td>クレーニング</td>
                                    <td>延床面積</td>
                                    <td class="text-end">100.00</td>
                                    <td>㎡</td>
                                    <td class="text-end">680</td>
                                    <td class="text-end">68,000</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>重機費用</td>
                                    <td>レッカー費用</td>
                                    <td>必須項目</td>
                                    <td class="text-end">1.00</td>
                                    <td>式</td>
                                    <td class="text-end">58,000</td>
                                    <td class="text-end">58,000</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>防蟻処理</td>
                                    <td>木部 GL+1000m（外周部）</td>
                                    <td>建築面積</td>
                                    <td class="text-end">40.00</td>
                                    <td>㎡</td>
                                    <td class="text-end">780</td>
                                    <td class="text-end">31,200</td>
                                    <td>家価値サポート60に含む</td>
                                </tr>
                                <tr>
                                    <td>防蟻処理</td>
                                    <td>土壌処理(5年保証)</td>
                                    <td>建築面積</td>
                                    <td class="text-end">40.00</td>
                                    <td>㎡</td>
                                    <td class="text-end">780</td>
                                    <td class="text-end">31,200</td>
                                    <td>家価値サポート60に含む</td>
                                </tr>
                                <tr>
                                    <td>仮設電気</td>
                                    <td>設置費・申請含む</td>
                                    <td>必須項目</td>
                                    <td class="text-end">1.00</td>
                                    <td>式</td>
                                    <td class="text-end">42,000</td>
                                    <td class="text-end">42,000</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>仮設水道</td>
                                    <td>本設量水器</td>
                                    <td>必須項目</td>
                                    <td class="text-end">1.00</td>
                                    <td>式</td>
                                    <td class="text-end">26,000</td>
                                    <td class="text-end">26,000</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>仮設トイレ</td>
                                    <td>4ヶ月、汲取り費用含む</td>
                                    <td>必須項目</td>
                                    <td class="text-end">1.00</td>
                                    <td>式</td>
                                    <td class="text-end">21,000</td>
                                    <td class="text-end">21,000</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>工事発生廃材処分費</td>
                                    <td>産業廃棄物処理費用</td>
                                    <td>延床坪数</td>
                                    <td class="text-end">30.25</td>
                                    <td>坪</td>
                                    <td class="text-end">5,500</td>
                                    <td class="text-end">166,375</td>
                                    <td></td>
                                </tr>
                                <tr class="table-light">
                                    <td colspan="6"></td>
                                    <td>小計</td>
                                    <td class="text-end">486,575</td>
                                </tr>
                                <!-- 新規行追加用 -->
                                <tr id="newRowTemplate" style="display: none;">
                                    <td><input type="text" class="form-control form-control-sm" placeholder="摘要"></td>
                                    <td><input type="text" class="form-control form-control-sm" placeholder="社内適用"></td>
                                    <td><input type="text" class="form-control form-control-sm" placeholder="数量定義"></td>
                                    <td><input type="number" class="form-control form-control-sm" placeholder="数量" step="0.01"></td>
                                    <td><input type="text" class="form-control form-control-sm" placeholder="単位"></td>
                                    <td><input type="number" class="form-control form-control-sm" placeholder="実行単価" step="0.01"></td>
                                    <td><input type="number" class="form-control form-control-sm" placeholder="実行金額" step="0.01"></td>
                                    <td><input type="text" class="form-control form-control-sm" placeholder="備考"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- プリントボタン -->
                    <div class="text-end mb-4">
                        <button class="btn btn-outline-secondary" onclick="window.print()">
                            <i class="bi bi-printer"></i> プリントアウト
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- フッター -->
    <div id="footer-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../style.js"></script>
    <script>
        fetch('user_header.html').then(r => r.text()).then(html => document.getElementById('header-container').innerHTML = html);
        fetch('user_footer.html').then(r => r.text()).then(html => document.getElementById('footer-container').innerHTML = html);
        
        let isEditMode = false;
        
        // 編集モード切り替え
        function toggleEditMode() {
            const editBtn = document.getElementById('editBtn');
            const addRowBtn = document.getElementById('addRowBtn');
            const table = document.querySelector('table tbody');
            const rows = table.querySelectorAll('tr:not(.table-light):not(#newRowTemplate)');
            
            isEditMode = !isEditMode;
            
            if (isEditMode) {
                // 編集モードに切り替え
                editBtn.innerHTML = '<i class="bi bi-check-circle"></i> 確定';
                editBtn.className = 'btn btn-success btn-sm';
                addRowBtn.style.display = 'inline-block';
                
                // 数量、実行単価、備考を編集可能にする
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 8) {
                        // 数量（4番目）
                        const quantityCell = cells[3];
                        if (quantityCell && !quantityCell.querySelector('input')) {
                            const currentValue = quantityCell.textContent.trim();
                            quantityCell.innerHTML = `<input type="number" class="form-control form-control-sm" value="${currentValue}" step="0.01">`;
                        }
                        
                        // 実行単価（6番目）
                        const unitPriceCell = cells[5];
                        if (unitPriceCell && !unitPriceCell.querySelector('input')) {
                            const currentValue = unitPriceCell.textContent.trim().replace(/[¥,]/g, '');
                            unitPriceCell.innerHTML = `<input type="number" class="form-control form-control-sm" value="${currentValue}" step="0.01">`;
                        }
                        
                        // 備考（8番目）
                        const noteCell = cells[7];
                        if (noteCell && !noteCell.querySelector('input')) {
                            const currentValue = noteCell.textContent.trim();
                            noteCell.innerHTML = `<input type="text" class="form-control form-control-sm" value="${currentValue}">`;
                        }
                    }
                });
            } else {
                // 表示モードに戻す
                editBtn.innerHTML = '<i class="bi bi-pencil"></i> 編集';
                editBtn.className = 'btn btn-outline-primary btn-sm';
                addRowBtn.style.display = 'none';
                
                // 入力値をテキストに戻す
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 8) {
                        // 数量
                        const quantityCell = cells[3];
                        const quantityInput = quantityCell.querySelector('input');
                        if (quantityInput) {
                            quantityCell.textContent = quantityInput.value;
                        }
                        
                        // 実行単価
                        const unitPriceCell = cells[5];
                        const unitPriceInput = unitPriceCell.querySelector('input');
                        if (unitPriceInput) {
                            unitPriceCell.textContent = unitPriceInput.value;
                        }
                        
                        // 備考
                        const noteCell = cells[7];
                        const noteInput = noteCell.querySelector('input');
                        if (noteInput) {
                            noteCell.textContent = noteInput.value;
                        }
                    }
                });
                
                // 新規行を非表示にする
                const newRowTemplate = document.getElementById('newRowTemplate');
                if (newRowTemplate) {
                    newRowTemplate.style.display = 'none';
                }
            }
        }
        
        // 新規行追加
        function addNewRow() {
            const template = document.getElementById('newRowTemplate');
            const tbody = template.parentNode;
            
            // テンプレートを複製
            const newRow = template.cloneNode(true);
            newRow.id = 'newRow-' + Date.now(); // ユニークなID
            newRow.style.display = ''; // 表示
            
            // 小計行の前に挿入
            const subtotalRow = tbody.querySelector('.table-light');
            tbody.insertBefore(newRow, subtotalRow);
            
            // テンプレートは非表示のまま
            template.style.display = 'none';
        }
    </script>
</body>
</html>
