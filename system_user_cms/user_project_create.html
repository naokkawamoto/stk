<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>新規工事登録</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap CSS (5系) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons CDN -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css" rel="stylesheet" />
  <!-- カスタムCSS -->
  <link rel="stylesheet" href="../style.css">
  <style>
    .section-card { margin-bottom: 1.5rem; }
    .section-card .card-header { background-color: #f8f9fa; font-weight: bold; }
    .import-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; }
    .import-btn:hover { background: linear-gradient(135deg, #5a6fd6 0%, #6a4190 100%); }
    .form-section { background-color: #fafafa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    .member-select-area { border: 1px dashed #dee2e6; padding: 1rem; border-radius: 8px; min-height: 100px; }
    .member-badge { display: inline-flex; align-items: center; gap: 4px; margin: 4px; padding: 6px 12px; background-color: #e9ecef; border-radius: 20px; font-size: 0.85rem; }
    .member-badge .remove-btn { cursor: pointer; color: #dc3545; }
    .permission-select { font-size: 0.8rem; padding: 2px 8px; }
    .nav-section { position: sticky; top: 80px; }
    .nav-section .nav-link { font-size: 0.85rem; padding: 8px 12px; color: #495057; border-left: 3px solid transparent; }
    .nav-section .nav-link:hover { background-color: #f8f9fa; }
    .nav-section .nav-link.active { background-color: #e7f1ff; border-left-color: #0d6efd; color: #0d6efd; }
  </style>
</head>
<body>
  <!-- ヘッダー -->
  <div id="header-container"></div>

  <div class="container-fluid mt-4 px-4">
    <div class="row">
      <!-- 左ナビゲーション -->
      <nav class="col-md-2">
        <div class="nav-section">
          <div class="list-group small" id="sectionNav">
            <a href="#section-overview" class="list-group-item list-group-item-action active">工事概要</a>
            <a href="#section-schedule" class="list-group-item list-group-item-action">スケジュール</a>
            <a href="#section-drawing" class="list-group-item list-group-item-action">図面登録</a>
            <a href="#section-budget" class="list-group-item list-group-item-action">予算</a>
            <a href="#section-staff" class="list-group-item list-group-item-action">社内担当者</a>
            <a href="#section-partner" class="list-group-item list-group-item-action">外部協力会社</a>
            <a href="#section-documents" class="list-group-item list-group-item-action">資料</a>
          </div>
          <div class="mt-3">
            <button class="btn btn-primary w-100 mb-2" onclick="saveProject()">
              <i class="bi bi-check-circle me-1"></i>登録
            </button>
            <a href="user_project_list.html" class="btn btn-outline-secondary w-100">
              <i class="bi bi-arrow-left me-1"></i>一覧に戻る
            </a>
          </div>
        </div>
      </nav>

      <!-- メインコンテンツ -->
      <main class="col-md-10 px-4" style="padding-bottom: 100px;">
        <h4 class="mb-4 fw-bold"><i class="bi bi-plus-circle me-2"></i>新規工事登録</h4>

        <!-- セクション1：工事概要 -->
        <div class="card section-card" id="section-overview">
          <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span><i class="bi bi-building me-2"></i>工事概要</span>
            <button class="btn btn-sm import-btn text-white" onclick="importFromCore('overview')">
              <i class="bi bi-cloud-download me-1"></i>基幹システムから取り込み
            </button>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">工事名 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" placeholder="例：国道9号線舗装工事">
              </div>
              <div class="col-md-6">
                <label class="form-label">工事種類 <span class="text-danger">*</span></label>
                <select class="form-select">
                  <option value="">選択してください</option>
                  <option value="asphalt">アスファルト舗装工事</option>
                  <option value="concrete">コンクリート舗装工事</option>
                  <option value="repair">補修工事</option>
                  <option value="line">区画線工事</option>
                  <option value="other">その他</option>
                </select>
              </div>
              <div class="col-md-12">
                <label class="form-label">工事場所 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" placeholder="例：東京都港区芝浦1-2-3">
              </div>
              <div class="col-md-6">
                <label class="form-label">発注者</label>
                <input type="text" class="form-control" placeholder="例：国土交通省 関東地方整備局">
              </div>
              <div class="col-md-6">
                <label class="form-label">契約金額</label>
                <div class="input-group">
                  <input type="number" class="form-control" placeholder="例：50000000">
                  <span class="input-group-text">円</span>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label">工期開始日</label>
                <input type="date" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">工期終了日</label>
                <input type="date" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">責任者（社内）</label>
                <input type="text" class="form-control" placeholder="例：山田太郎">
              </div>
              <div class="col-md-6">
                <label class="form-label">現場代理人</label>
                <input type="text" class="form-control" placeholder="例：佐藤一郎">
              </div>
              <div class="col-md-12">
                <label class="form-label">備考</label>
                <textarea class="form-control" rows="3" placeholder="工事に関する備考を入力"></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- セクション2：スケジュール -->
        <div class="card section-card" id="section-schedule">
          <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span><i class="bi bi-calendar3 me-2"></i>スケジュール</span>
            <button class="btn btn-sm import-btn text-white" onclick="importFromCore('schedule')">
              <i class="bi bi-cloud-download me-1"></i>基幹システムから取り込み
            </button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-bordered" id="scheduleTable">
                <thead class="table-light">
                  <tr>
                    <th style="width: 200px;">工種</th>
                    <th style="width: 150px;">担当業者</th>
                    <th style="width: 140px;">開始予定日</th>
                    <th style="width: 140px;">終了予定日</th>
                    <th style="width: 80px;">操作</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><input type="text" class="form-control form-control-sm" placeholder="工種名"></td>
                    <td><input type="text" class="form-control form-control-sm" placeholder="業者名"></td>
                    <td><input type="date" class="form-control form-control-sm"></td>
                    <td><input type="date" class="form-control form-control-sm"></td>
                    <td><button class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
                  </tr>
                </tbody>
              </table>
            </div>
            <button class="btn btn-outline-primary btn-sm" onclick="addScheduleRow()">
              <i class="bi bi-plus me-1"></i>行を追加
            </button>
          </div>
        </div>

        <!-- セクション3：図面登録 -->
        <div class="card section-card" id="section-drawing">
          <div class="card-header py-2">
            <span><i class="bi bi-image me-2"></i>図面登録</span>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-12">
                <div class="border rounded p-4 text-center" style="border-style: dashed !important; background-color: #fafafa;">
                  <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #6c757d;"></i>
                  <p class="mt-2 mb-2">ファイルをドラッグ＆ドロップ、またはクリックして選択</p>
                  <input type="file" class="form-control" id="drawingFiles" multiple accept="image/*,.pdf" style="display: none;">
                  <button class="btn btn-outline-primary" onclick="document.getElementById('drawingFiles').click()">
                    <i class="bi bi-folder2-open me-1"></i>ファイルを選択
                  </button>
                </div>
              </div>
              <div class="col-md-12">
                <label class="form-label">登録済み図面</label>
                <div id="uploadedDrawings" class="text-muted small">まだ図面が登録されていません</div>
              </div>
            </div>
          </div>
        </div>

        <!-- セクション4：予算 -->
        <div class="card section-card" id="section-budget">
          <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span><i class="bi bi-calculator me-2"></i>予算</span>
            <button class="btn btn-sm import-btn text-white" onclick="importFromCore('budget')">
              <i class="bi bi-cloud-download me-1"></i>基幹システムから取り込み
            </button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-bordered" id="budgetTable">
                <thead class="table-light">
                  <tr>
                    <th style="width: 150px;">工種</th>
                    <th style="width: 150px;">仕様</th>
                    <th style="width: 80px;">単位</th>
                    <th style="width: 100px;">数量</th>
                    <th style="width: 120px;">単価</th>
                    <th style="width: 140px;">金額</th>
                    <th style="width: 80px;">操作</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><input type="text" class="form-control form-control-sm" placeholder="工種名"></td>
                    <td><input type="text" class="form-control form-control-sm" placeholder="仕様"></td>
                    <td><input type="text" class="form-control form-control-sm" placeholder="m2"></td>
                    <td><input type="number" class="form-control form-control-sm" placeholder="0"></td>
                    <td><input type="number" class="form-control form-control-sm" placeholder="0"></td>
                    <td><input type="number" class="form-control form-control-sm" placeholder="0" readonly></td>
                    <td><button class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
                  </tr>
                </tbody>
              </table>
            </div>
            <button class="btn btn-outline-primary btn-sm" onclick="addBudgetRow()">
              <i class="bi bi-plus me-1"></i>行を追加
            </button>
          </div>
        </div>

        <!-- セクション5：社内担当者 -->
        <div class="card section-card" id="section-staff">
          <div class="card-header py-2">
            <span><i class="bi bi-people me-2"></i>社内担当者</span>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">メンバーを選択</label>
                <select class="form-select" id="staffSelect" onchange="addStaffMember()">
                  <option value="">登録済みメンバーから選択...</option>
                  <option value="yamada">山田太郎（工事部長）</option>
                  <option value="suzuki">鈴木一郎（現場監督）</option>
                  <option value="tanaka">田中次郎（技術担当）</option>
                  <option value="sato">佐藤三郎（安全管理）</option>
                  <option value="ito">伊藤四郎（品質管理）</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">権限</label>
                <select class="form-select" id="staffPermission">
                  <option value="admin">管理者（全権限）</option>
                  <option value="editor">編集者（編集可）</option>
                  <option value="viewer">閲覧者（閲覧のみ）</option>
                </select>
              </div>
              <div class="col-md-12">
                <label class="form-label">選択済みメンバー</label>
                <div class="member-select-area" id="selectedStaff">
                  <span class="text-muted small">メンバーを選択してください</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- セクション6：外部協力会社 -->
        <div class="card section-card" id="section-partner">
          <div class="card-header py-2">
            <span><i class="bi bi-building me-2"></i>外部協力会社</span>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">協力会社を選択</label>
                <select class="form-select" id="partnerSelect" onchange="addPartnerCompany()">
                  <option value="">登録済み協力会社から選択...</option>
                  <option value="tokyo">東京舗装株式会社</option>
                  <option value="kanto">株式会社関東建設</option>
                  <option value="shutoken">首都圏道路株式会社</option>
                  <option value="nihon">日本道路工業株式会社</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">担当工種</label>
                <select class="form-select" id="partnerWorkType">
                  <option value="">選択してください</option>
                  <option value="asphalt">アスファルト舗装工</option>
                  <option value="removal">撤去工事</option>
                  <option value="line">区画線工</option>
                  <option value="base">路盤工</option>
                </select>
              </div>
              <div class="col-md-12">
                <label class="form-label">選択済み協力会社</label>
                <div class="member-select-area" id="selectedPartners">
                  <span class="text-muted small">協力会社を選択してください</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- セクション7：資料 -->
        <div class="card section-card" id="section-documents">
          <div class="card-header py-2">
            <span><i class="bi bi-folder me-2"></i>資料</span>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-12">
                <div class="border rounded p-4 text-center" style="border-style: dashed !important; background-color: #fafafa;">
                  <i class="bi bi-file-earmark-plus" style="font-size: 3rem; color: #6c757d;"></i>
                  <p class="mt-2 mb-2">資料ファイルをドラッグ＆ドロップ、またはクリックして選択</p>
                  <input type="file" class="form-control" id="documentFiles" multiple style="display: none;">
                  <button class="btn btn-outline-primary" onclick="document.getElementById('documentFiles').click()">
                    <i class="bi bi-folder2-open me-1"></i>ファイルを選択
                  </button>
                </div>
              </div>
              <div class="col-md-12">
                <label class="form-label">資料分類</label>
                <div class="row g-2">
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="docKY">
                      <label class="form-check-label" for="docKY">KY活動記録表</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="docSafety">
                      <label class="form-check-label" for="docSafety">安全施工サイクル</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="docPlan">
                      <label class="form-check-label" for="docPlan">施工計画書</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="docQuality">
                      <label class="form-check-label" for="docQuality">品質管理計画書</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="docPermit">
                      <label class="form-check-label" for="docPermit">道路使用許可</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="docContract">
                      <label class="form-check-label" for="docContract">契約書類</label>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-12">
                <label class="form-label">登録済み資料</label>
                <div id="uploadedDocuments" class="text-muted small">まだ資料が登録されていません</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 登録ボタン（下部固定） -->
        <div class="position-fixed bottom-0 end-0 p-3 bg-white border-top" style="left: 0; z-index: 1000;">
          <div class="container-fluid">
            <div class="d-flex justify-content-end gap-2">
              <a href="user_project_list.html" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle me-1"></i>キャンセル
              </a>
              <button class="btn btn-primary" onclick="saveProject()">
                <i class="bi bi-check-circle me-1"></i>工事を登録
              </button>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- フッター -->
  <div id="footer-container"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- カスタムスクリプト -->
  <script src="../style.js"></script>
  <script>
    fetch('user_header.html')
      .then(res => res.text())
      .then(html => document.getElementById('header-container').innerHTML = html);
    fetch('user_footer.html')
      .then(res => res.text())
      .then(html => document.getElementById('footer-container').innerHTML = html);

    // 基幹システムからの取り込み（ダミー）
    function importFromCore(section) {
      const sectionNames = {
        'overview': '工事概要',
        'schedule': 'スケジュール',
        'budget': '予算'
      };
      alert(`基幹システムから「${sectionNames[section]}」データを取り込みます。\n※実際の実装では、APIを呼び出してデータを取得します。`);
    }

    // スケジュール行追加
    function addScheduleRow() {
      const tbody = document.querySelector('#scheduleTable tbody');
      const newRow = `
        <tr>
          <td><input type="text" class="form-control form-control-sm" placeholder="工種名"></td>
          <td><input type="text" class="form-control form-control-sm" placeholder="業者名"></td>
          <td><input type="date" class="form-control form-control-sm"></td>
          <td><input type="date" class="form-control form-control-sm"></td>
          <td><button class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
        </tr>
      `;
      tbody.insertAdjacentHTML('beforeend', newRow);
    }

    // 予算行追加
    function addBudgetRow() {
      const tbody = document.querySelector('#budgetTable tbody');
      const newRow = `
        <tr>
          <td><input type="text" class="form-control form-control-sm" placeholder="工種名"></td>
          <td><input type="text" class="form-control form-control-sm" placeholder="仕様"></td>
          <td><input type="text" class="form-control form-control-sm" placeholder="m2"></td>
          <td><input type="number" class="form-control form-control-sm" placeholder="0"></td>
          <td><input type="number" class="form-control form-control-sm" placeholder="0"></td>
          <td><input type="number" class="form-control form-control-sm" placeholder="0" readonly></td>
          <td><button class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
        </tr>
      `;
      tbody.insertAdjacentHTML('beforeend', newRow);
    }

    // 行削除
    function removeRow(btn) {
      btn.closest('tr').remove();
    }

    // 社内担当者追加
    let selectedStaffList = [];
    function addStaffMember() {
      const select = document.getElementById('staffSelect');
      const permission = document.getElementById('staffPermission').value;
      const value = select.value;
      const text = select.options[select.selectedIndex].text;
      
      if (value && !selectedStaffList.includes(value)) {
        selectedStaffList.push(value);
        const container = document.getElementById('selectedStaff');
        if (selectedStaffList.length === 1) {
          container.innerHTML = '';
        }
        
        const permissionLabels = {
          'admin': '管理者',
          'editor': '編集者',
          'viewer': '閲覧者'
        };
        
        const badge = document.createElement('span');
        badge.className = 'member-badge';
        badge.innerHTML = `
          ${text}
          <select class="permission-select form-select form-select-sm" style="width: auto; margin-left: 8px;">
            <option value="admin" ${permission === 'admin' ? 'selected' : ''}>管理者</option>
            <option value="editor" ${permission === 'editor' ? 'selected' : ''}>編集者</option>
            <option value="viewer" ${permission === 'viewer' ? 'selected' : ''}>閲覧者</option>
          </select>
          <i class="bi bi-x-circle remove-btn" onclick="removeStaff('${value}', this)"></i>
        `;
        container.appendChild(badge);
      }
      select.value = '';
    }

    function removeStaff(value, element) {
      selectedStaffList = selectedStaffList.filter(v => v !== value);
      element.closest('.member-badge').remove();
      if (selectedStaffList.length === 0) {
        document.getElementById('selectedStaff').innerHTML = '<span class="text-muted small">メンバーを選択してください</span>';
      }
    }

    // 協力会社追加
    let selectedPartnerList = [];
    function addPartnerCompany() {
      const select = document.getElementById('partnerSelect');
      const workType = document.getElementById('partnerWorkType');
      const value = select.value;
      const text = select.options[select.selectedIndex].text;
      const workTypeText = workType.options[workType.selectedIndex].text;
      
      if (value && !selectedPartnerList.includes(value)) {
        selectedPartnerList.push(value);
        const container = document.getElementById('selectedPartners');
        if (selectedPartnerList.length === 1) {
          container.innerHTML = '';
        }
        
        const badge = document.createElement('span');
        badge.className = 'member-badge';
        badge.innerHTML = `
          ${text}
          <span class="badge bg-primary ms-2">${workTypeText || '未設定'}</span>
          <i class="bi bi-x-circle remove-btn" onclick="removePartner('${value}', this)"></i>
        `;
        container.appendChild(badge);
      }
      select.value = '';
    }

    function removePartner(value, element) {
      selectedPartnerList = selectedPartnerList.filter(v => v !== value);
      element.closest('.member-badge').remove();
      if (selectedPartnerList.length === 0) {
        document.getElementById('selectedPartners').innerHTML = '<span class="text-muted small">協力会社を選択してください</span>';
      }
    }

    // 工事登録
    function saveProject() {
      if (confirm('工事を登録しますか？')) {
        alert('工事を登録しました。\n※実際の実装では、データベースに保存されます。');
        window.location.href = 'user_project_list.html';
      }
    }

    // スクロールスパイ
    document.addEventListener('scroll', function() {
      const sections = document.querySelectorAll('.section-card');
      const navLinks = document.querySelectorAll('#sectionNav .list-group-item');
      
      let currentSection = '';
      sections.forEach(section => {
        const sectionTop = section.offsetTop - 150;
        if (window.scrollY >= sectionTop) {
          currentSection = section.getAttribute('id');
        }
      });
      
      navLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href') === '#' + currentSection) {
          link.classList.add('active');
        }
      });
    });
  </script>
</body>
</html>
